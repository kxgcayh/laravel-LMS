!function(e,t){"use strict";if("function"==typeof define&&define.amd&&define.amd.jQuery)define(["jquery"],(function(r){return t(r,e)}));else{if("object"!=typeof exports)return t(e.jQuery||e.$,e);module.exports=t}}(this,(function(e,t){"use strict";var r=e.ajax,n=[],o=[],s=[],a=/=\?(&|$)/,i=(new Date).getTime();function u(t,r){h.debug(t,["Checking mock data against request data",t,r]);var n=!0;if(e.isFunction(t))return!!t(r);if("string"==typeof r){if(e.isFunction(t.test))return t.test(r);if("object"!=typeof t)return t===r;r=function(e){var t,r,n,o,s={},a=String(e).split(/&/);for(t=0,r=a.length;t<r;++t){n=a[t];try{n=(n=decodeURIComponent(n.replace(/\+/g," "))).split(/=/)}catch(e){continue}s[n[0]]?(s[n[0]].splice||(o=s[n[0]],s[n[0]]=[],s[n[0]].push(o)),s[n[0]].push(n[1])):s[n[0]]=n[1]}return h.debug(null,["Getting query params from string",e,s]),s}(r)}return e.each(t,(function(o){return void 0===r[o]?n=!1:void(n="object"==typeof r[o]&&null!==r[o]?(n&&e.isArray(r[o])&&(n=e.isArray(t[o])&&r[o].length===t[o].length),n&&u(t[o],r[o])):t[o]&&e.isFunction(t[o].test)?n&&t[o].test(r[o]):n&&t[o]===r[o])})),n}function l(t,r){return t[r]===e.mockjaxSettings[r]}function c(e){return"number"==typeof e&&0<=e}function p(t){if(e.isArray(t)&&2===t.length){var r=t[0],n=t[1];if(c(r)&&c(n))return Math.floor(Math.random()*(n-r))+r}else if(c(t))return t;return 500}function f(n,o,s){h.debug(n,["Sending fake XHR request",n,o,s]);var a,i=(a=this,function(){return function(){function r(){var r,s;this.readyState=4,"json"===o.dataType&&"object"==typeof n.responseText?this.responseText=JSON.stringify(n.responseText):"xml"===o.dataType?"string"==typeof n.responseXML?(this.responseXML=function(r){void 0===t.DOMParser&&t.ActiveXObject&&(t.DOMParser=function(){},DOMParser.prototype.parseFromString=function(e){var t=new ActiveXObject("Microsoft.XMLDOM");return t.async="false",t.loadXML(e),t});try{var n=(new DOMParser).parseFromString(r,"text/xml");if(!e.isXMLDoc(n))throw new Error("Unable to parse XML");if(1===e("parsererror",n).length)throw new Error("Error: "+e(n).text());return n}catch(r){var o=void 0===r.name?r:r.name+": "+r.message;return void e(document).trigger("xmlParseError",[o])}}(n.responseXML),this.responseText=n.responseXML):this.responseXML=n.responseXML:"object"==typeof n.responseText&&null!==n.responseText?(n.contentType="application/json",this.responseText=JSON.stringify(n.responseText)):this.responseText=n.responseText,e.isArray(n.status)?(s=Math.floor(Math.random()*n.status.length),this.status=n.status[s]):"number"!=typeof n.status&&"string"!=typeof n.status||(this.status=n.status),"string"==typeof n.statusText&&(this.statusText=n.statusText),r=this.onload||this.onreadystatechange,e.isFunction(r)?(n.isTimeout&&(this.status=-1),r.call(this,n.isTimeout?"timeout":void 0)):n.isTimeout&&(this.status=-1)}if(this.status=n.status,this.statusText=n.statusText,this.readyState=1,e.isFunction(n.response)){if(2===n.response.length)return void n.response(s,(function(){r.call(a)}));n.response(s)}r.call(a)}.apply(a)});n.proxy?(h.info(n,["Retrieving proxy file: "+n.proxy,n]),r({global:!1,url:n.proxy,type:n.proxyType,data:n.data,async:o.async,dataType:"script"===o.dataType?"text/plain":o.dataType,complete:function(e){n.responseXML=n.responseText=e.responseText,l(n,"status")&&(n.status=e.status),l(n,"statusText")&&(n.statusText=e.statusText),!1===o.async?i():this.responseTimer=setTimeout(i,p(n.responseTime))}})):!1===o.async?i():this.responseTimer=setTimeout(i,p(n.responseTime))}function g(n,o,s){var u;if("GET"===(u=n).type.toUpperCase()?a.test(u.url)||(u.url+=(/\?/.test(u.url)?"&":"?")+(u.jsonp||"callback")+"=?"):u.data&&a.test(u.data)||(u.data=(u.data?u.data+"&":"")+(u.jsonp||"callback")+"=?"),n.dataType="json",n.data&&a.test(n.data)||a.test(n.url)){!function(e,r,n){var o=n&&n.context||e,s="string"==typeof e.jsonpCallback&&e.jsonpCallback||"jsonp"+i++;e.data&&(e.data=(e.data+"").replace(a,"="+s+"$1")),e.url=e.url.replace(a,"="+s+"$1"),t[s]=t[s]||function(){x(e,o,r),m(e,o),t[s]=void 0;try{delete t[s]}catch(e){}},e.jsonpCallback=s}(n,o,s);var l=/^(\w+:)?\/\/([^\/?#]+)/.exec(n.url),c=l&&(l[1]&&l[1]!==location.protocol||l[2]!==location.host);if(n.dataType="script","GET"===n.type.toUpperCase()&&c)return function(t,n,o){h.debug(n,["Performing JSONP request",n,t,o]);var s=o&&o.context||t,a=e.Deferred?new e.Deferred:null;if(n.response&&e.isFunction(n.response))n.response(o);else if("object"==typeof n.responseText)e.globalEval("("+JSON.stringify(n.responseText)+")");else{if(n.proxy)return h.info(n,["Performing JSONP proxy request: "+n.proxy,n]),r({global:!1,url:n.proxy,type:n.proxyType,data:n.data,dataType:"script"===t.dataType?"text/plain":t.dataType,complete:function(r){e.globalEval("("+r.responseText+")"),d(t,n,s,a)}}),a;e.globalEval("("+("string"==typeof n.responseText?'"'+n.responseText+'"':n.responseText)+")")}return d(t,n,s,a),a}(n,o,s)||!0}return null}function d(t,r,n,o){var s;setTimeout((function(){if(x(t,n,r),m(t,n),o){try{s=e.parseJSON(r.responseText)}catch(e){}o.resolveWith(n,[s||r.responseText]),h.log(r,["JSONP mock call complete",r,o])}}),p(r.responseTime))}function x(t,r,n){t.success&&t.success.call(r,n.responseText||"","success",{}),t.global&&(t.context?e(t.context):e.event).trigger("ajaxSuccess",[{},t])}function m(t,r){t.complete&&t.complete.call(r,{statusText:"success",status:200},"success"),t.global&&(t.context?e(t.context):e.event).trigger("ajaxComplete",[{},t]),t.global&&!--e.active&&e.event.trigger("ajaxStop")}e.extend({ajax:function t(a,i){var l,c,p,d;h.debug(null,["Ajax call intercepted",a,i]),"object"==typeof a?(i=a,a=void 0):(i=i||{}).url=a||i.url,(c=e.ajaxSetup({},i)).type=c.method=c.method||c.type,d=function(t,r){var n=i[t.toLowerCase()];return function(){e.isFunction(n)&&n.apply(this,[].slice.call(arguments)),r["onAfter"+t]()}};for(var x=0;x<n.length;x++){var m=e.mockjaxSettings.matchInRegistrationOrder?x:n.length-1-x,y=n[m];if(y){if(p=function(t,r){if(e.isFunction(t))return t(r);var n,o=t.namespace||void 0===t.namespace&&e.mockjaxSettings.namespace;if(e.isFunction(t.url.test)){if(o&&(o=o.replace(/(\/+)$/,""),n=t.url.source.replace(/^(\^+)/,"").replace(/^/,"^("+o+")?/?"),t.url=new RegExp(n)),!t.url.test(r.url))return null}else{var s=t.url;o&&(s=[o.replace(/(\/+)$/,""),t.url.replace(/^(\/+)/,"")].join("/"));var a=s.indexOf("*");if(s!==r.url&&-1===a||!new RegExp(s.replace(/[-[\]{}()+?.,\\^$|#\s]/g,"\\$&").replace(/\*/g,".+")).test(r.url))return null}if(t.requestHeaders){if(void 0===r.headers)return null;var i=!1;if(e.each(t.requestHeaders,(function(e,t){if(r.headers[e]!==t)return!(i=!0)})),i)return null}return!(!t.data||r.data&&u(t.data,r.data))||t&&t.type&&t.type.toLowerCase()!==r.type.toLowerCase()?null:t}(y,c)){if(e.mockjaxSettings.retainAjaxCalls&&o.push(c),h.info(p,["MOCK "+c.type.toUpperCase()+": "+c.url,e.ajaxSetup({},c)]),301!==p.status&&302!==p.status||"GET"!==c.type.toUpperCase()&&"HEAD"!==c.type.toUpperCase()||!p.headers.Location)return c.dataType&&"JSONP"===c.dataType.toUpperCase()&&(l=g(c,p,i))||(i.crossDomain=!1,p.cache=c.cache,p.timeout=c.timeout,p.global=c.global,p.isTimeout&&(1<p.responseTime?i.timeout=p.responseTime-1:(p.responseTime=2,i.timeout=1)),e.isFunction(p.onAfterSuccess)&&(i.success=d("Success",p)),e.isFunction(p.onAfterError)&&(i.error=d("Error",p)),e.isFunction(p.onAfterComplete)&&(i.complete=d("Complete",p)),function(e,t){if(e.url instanceof RegExp&&e.hasOwnProperty("urlParams")){var r=e.url.exec(t.url);if(1!==r.length){r.shift();for(var n=0,o=r.length,s=e.urlParams.length,a=Math.min(o,s),i={};n<a;n++){i[e.urlParams[n]]=r[n]}t.urlParams=i}}}(p,i),function(t,n,o,s){l=r.call(e,e.extend(!0,{},o,{xhr:function(){return r=t,a=n,i=o,u=s,h.debug(r,["Creating new mock XHR object",r,a,i,u]),void 0===(r=e.extend(!0,{},e.mockjaxSettings,r)).headers&&(r.headers={}),void 0===a.headers&&(a.headers={}),r.contentType&&(r.headers["content-type"]=r.contentType),{status:r.status,statusText:r.statusText,readyState:1,open:function(){},send:function(){u.fired=!0,f.call(this,r,a,i)},abort:function(){clearTimeout(this.responseTimer)},setRequestHeader:function(e,t){a.headers[e]=t},getResponseHeader:function(e){return r.headers&&r.headers[e]?r.headers[e]:"last-modified"===e.toLowerCase()?r.lastModified||(new Date).toString():"etag"===e.toLowerCase()?r.etag||"":"content-type"===e.toLowerCase()?r.contentType||"text/plain":void 0},getAllResponseHeaders:function(){var t="";return r.contentType&&(r.headers["content-type"]=r.contentType),e.each(r.headers,(function(e,r){t+=e+": "+r+"\n"})),t}};var r,a,i,u}}))}(p,c,i,y)),l;h.debug("Doing mock redirect to",p.headers.Location,c.type);for(var T={},j=Object.keys(i),v=0;v<j.length;v++)T[j[v]]=i[j[v]];return T.url=p.headers.Location,T.headers={Referer:i.url},t(T)}h.debug(y,["Mock does not match request",a,c])}}if(h.log(null,["No mock matched to request",a,i]),e.mockjaxSettings.retainAjaxCalls&&s.push(i),!0===e.mockjaxSettings.throwUnmocked)throw new Error("AJAX not mocked: "+i.url);return h.log("Real ajax call to",i.url),r.apply(e,[i])}});var h={_log:function(t,r,n){var o=e.mockjaxSettings.logging;if(t&&void 0!==t.logging&&(o=t.logging),n=0===n?n:n||y.LOG,r=r.splice?r:[r],!(!1===o||o<n))return e.mockjaxSettings.log?e.mockjaxSettings.log(t,r[1]||r[0]):e.mockjaxSettings.logger&&e.mockjaxSettings.logger[e.mockjaxSettings.logLevelMethods[n]]?e.mockjaxSettings.logger[e.mockjaxSettings.logLevelMethods[n]].apply(e.mockjaxSettings.logger,r):void 0},debug:function(e,t){return h._log(e,t,y.DEBUG)},log:function(e,t){return h._log(e,t,y.LOG)},info:function(e,t){return h._log(e,t,y.INFO)},warn:function(e,t){return h._log(e,t,y.WARN)},error:function(e,t){return h._log(e,t,y.ERROR)}},y={DEBUG:4,LOG:3,INFO:2,WARN:1,ERROR:0};return e.mockjaxSettings={log:null,logger:t.console,logging:2,logLevelMethods:["error","warn","info","log","debug"],matchInRegistrationOrder:!0,namespace:null,status:200,statusText:"OK",responseTime:500,isTimeout:!1,throwUnmocked:!1,retainAjaxCalls:!0,contentType:"text/plain",response:"",responseText:"",responseXML:"",proxy:"",proxyType:"GET",lastModified:null,etag:"",headers:{etag:"IJF@H#@923uf8023hFO@I#H#","content-type":"text/plain"}},e.mockjax=function(t){if(e.isArray(t))return e.map(t,(function(t){return e.mockjax(t)}));var r=n.length;return n[r]=t,h.log(t,["Created new mock handler",t]),r},e.mockjax._logger=h,e.mockjax.clear=function(e){"string"==typeof e||e instanceof RegExp?n=function(e){for(var t,r=[],o=e instanceof RegExp?function(t){return e.test(t)}:function(t){return e===t},s=0,a=n.length;s<a;s++)o((t=n[s]).url)?h.log(t,["Clearing mock: "+(t&&t.url),t]):r.push(t);return r}(e):e||0===e?(h.log(n[e],["Clearing mock: "+(n[e]&&n[e].url),n[e]]),n[e]=null):(h.log(null,"Clearing all mocks"),n=[]),o=[],s=[]},e.mockjax.clearRetainedAjaxCalls=function(){o=[],s=[],h.debug(null,"Cleared retained ajax calls")},e.mockjax.handler=function(e){if(1===arguments.length)return n[e]},e.mockjax.handlers=function(){return n},e.mockjax.mockedAjaxCalls=function(){return o},e.mockjax.unfiredHandlers=function(){for(var e=[],t=0,r=n.length;t<r;t++){var o=n[t];null===o||o.fired||e.push(o)}return e},e.mockjax.unmockedAjaxCalls=function(){return s},e.mockjax}));
